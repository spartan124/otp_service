name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # JOB 1: Determine Environment & Validation
  setup:
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.target.outputs.env_name }}
      service_id: ${{ steps.target.outputs.service_id }}
      url: ${{ steps.target.outputs.url }}
    steps:
      - name: Set Deploy Target
        id: target
        # Pass secrets as env vars to avoid quoting issues
        env:
          PROD_ID: ${{ secrets.RENDER_SERVICE_ID_PROD }}
          STAGING_ID: ${{ secrets.RENDER_SERVICE_ID_STAGING }}
          PROD_URL: ${{ vars.RENDER_URL_PROD }}
          STAGING_URL: ${{ vars.RENDER_URL_STAGING }}
        run: |
          echo "ðŸ” Debugging Deployment Target..."
          
          # Default to Staging
          ENV_NAME="staging"
          SERVICE_ID="$STAGING_ID"
          URL="$STAGING_URL"

          # Check for Production Triggers
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "âœ… Trigger: Push to Main -> Production"
            ENV_NAME="production"
            SERVICE_ID="$PROD_ID"
            URL="$PROD_URL"
          elif [[ "${{ inputs.environment }}" == "production" ]]; then
            echo "âœ… Trigger: Manual Dispatch -> Production"
            ENV_NAME="production"
            SERVICE_ID="$PROD_ID"
            URL="$PROD_URL"
          else
            echo "âœ… Trigger: Default/Manual -> Staging"
          fi

          # ðŸ›‘ SAFETY CHECK: Fail here if ID is missing
          if [[ -z "$SERVICE_ID" ]]; then
            echo "::error::âŒ Service ID is EMPTY! Check your GitHub Secrets for RENDER_SERVICE_ID_STAGING or RENDER_SERVICE_ID_PROD."
            exit 1
          fi

          echo "ðŸš€ Target Environment: $ENV_NAME"
          echo "ðŸ†” Service ID: ${SERVICE_ID:0:5}*****" # Print first 5 chars for verification

          # Set Outputs
          echo "env_name=$ENV_NAME" >> "$GITHUB_OUTPUT"
          echo "service_id=$SERVICE_ID" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

  # JOB 2: Deploy
  deploy:
    needs: setup
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.setup.outputs.env_name }}
      url: ${{ needs.setup.outputs.url }}

    steps:
      - name: Deploy to Render
        uses: JorgeLNJunior/render-deploy@v1.4.4
        with:
          service_id: ${{ needs.setup.outputs.service_id }}
          api_key: ${{ secrets.RENDER_API_KEY }}
          clear_cache: false
          wait_deploy: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
